---
title: "Main script Schmits388143"
author: "Marie Schmit"
date: "2022-12-11"
output: html_document
---

```{r}
#install.packages("pheatmap")
#install.packages("caret")
```


Load libraries and packages
```{r}
require("mixOmics")
require("rgl")
require("matlab")
require("R.matlab")
require("ptw")
require("dplyr")
require("class")
require("gmodels")
require("caret")
require("rpart")
require("rpart.plot")
require("kernlab")
require("MASS")
require("grDevices")
require("factoextra")
require("cluster")
require("ggplot2")
require("RColorBrewer")
require("graphics")
require("caret")
library("pheatmap")
```


Functions are saved in a dedicated script.

```{r}
#Source the functions script
source("functions_MSchmit_s388143.R")
```

# Data preparation and exploratory analysis
Load data files and create datasets.

```{r}
enose <- read.table("Enose_data-1.csv", sep = ",", header = TRUE, row.names = 1)
sensory <- read.table("Sensory_score-1.csv", sep = ",", header = TRUE, row.names = 1)
counts <- read.table("Bacterial_Counts-1.csv", sep = ",", header = TRUE, row.names = 1)
hplc <- read.table("HPLC_data-1.csv", sep = ",", header = TRUE, row.names = 1)
```


Combine all rows from the csv. Match the samples ID of HPLC and enose data with  sensory and bacterial counts data.
```{r}
# Merge enose and sensory
AllData_enose_sens <- merge_data(enose, sensory, AllData_enose_sens)

# Merge HPLC and sensory
AllData_HPLC_sens <- merge_data(hplc, sensory, AllData_HPLC_sens)

# Merge enose and counts
AllData_enose_counts <- merge_data(enose, counts, AllData_enose_counts)

#Merge HPLC and counts
AllData_HPLC_counts <- merge_data(hplc, counts, AllData_HPLC_counts)

#Merge sensory and counts
AllData_counts_sens <- merge_data(counts, sensory, AllData_counts_sens)

# Sensory values for enose and HPLC
AllData_enose_sens$sensory <- as.factor(AllData_enose_sens$sensory)
AllData_HPLC_sens$sensory <- as.factor(AllData_HPLC_sens$sensory)

sensory_enose <- AllData_enose_sens$sensory
sensory_HPLC <- AllData_HPLC_sens$sensory

# Samples ID
samples <- rownames(AllData_enose_counts)
```

## PCA visualisation
PCA of enose data grouped by sensors.
```{r}
pca.AllData_enose_sens <- pca_visualisation(pca.AllData_enose_sens, AllData_enose_sens, 3, sensory_enose, "lattice")

```
PCA of HPLC data grouped by sensors.
```{r}
pca.AllData_HPLC_sens <- pca_visualisation(pca.AllData_HPLC_sens, AllData_HPLC_sens, 3, sensory_HPLC, "lattice")

```
Create 3D PCA plots to better see all features.
```{r}
pca.AllData_enose_sens <- pca_visualisation(pca.AllData_enose_sens, AllData_enose_sens, 3, sensory_enose, "3d")
pca.AllData_HPLC_sens <- pca_visualisation(pca.AllData_HPLC_sens, AllData_HPLC_sens, 3, sensory_HPLC, "3d")
```

Create biplots of pca model.
```{r}
pca_var(pca.AllData_enose_sens, sensory_enose, AllData_enose_sens)
```

```{r}
pca_var(pca.AllData_HPLC_sens, sensory_HPLC, AllData_HPLC_sens)
```
HCA analysis
```{r}
hca_visualisation(AllData_enose_sens)
```
```{r}
hca_visualisation(AllData_HPLC_sens)
```

```{r}
pca_visualisation(pca.AllData_enose_sens, AllData_enose_sens, 3, sensory_enose, "lattice")
```

## 2. Bacterial counts against time for each temperature and bacteria

```{r}
# Add temperature and time columns to data frame counts of bacteria
# We remove the samples F1a and F1b because we do not know their temperature
counts_temp_time <- temp_time(AllData_counts_sens[-c(1,2),])
```
For each bacteria: TVC in full line, Pseudomonia in dot line.

```{r}
# Plot bacterial counts for each time for TVC
ggplot(data = counts_temp_time, 
       aes(x = as.numeric(counts_temp_time$Time), 
           y = as.numeric(counts_temp_time$TVC))) +
  #Color the lines by temperature
  geom_line(aes(colour = counts_temp_time$Temperature)) +
  #Add dashed lines for pseudomonads counts
  geom_line(aes(y = as.numeric(counts_temp_time$Pseudomonads), 
                colour = counts_temp_time$Temperature), linetype = "dashed") +
  #Add labels
  xlab("Time (in hours)")+
  ylab("Bacterial count (Pseudomonads in dots)")+
  ggtitle("Bacterial count per time and temperature")+
  labs(color = "Temperature")

#Save plot
ggsave(filename = paste("Plots/2_CountsPerTime.png"))
```

## 3. Boxplots of bacterial counts for each type of bacteria against sensory score

```{r}
ggplot(data = counts_temp_time, mapping = aes())+
  #Boxes for TVC
  geom_boxplot(aes(group = counts_temp_time$sensory, y = counts_temp_time$TVC, x = counts_temp_time$sensory-0.25, colour = "TVC"), width = 0.4)+
  #Boxes for pseudomonas
  geom_boxplot(aes(group = counts_temp_time$sensory, y = counts_temp_time$Pseudomonads, x = counts_temp_time$sensory+0.25, colour = "Pseudomonads"), width = 0.4)+
  #Create legend
  scale_color_manual("",
                     breaks = c("TVC", "Pseudomonads"),
                     values = c("Salmon", "Steelblue"))+
  # Set axis labels
  xlab("TVC counts")+
  ylab("Sensory")+
  ggtitle("Boxplots of bacterial counts against sensory")

#Save plot
ggsave(filename = paste("Plots/3_BoxPlot.png"))
```
# Classification
## Classification method 1: knn
### knn with HCLP
Partition the dataset with 7:3 optimisation
Partition the data once for HPLC.
```{r}
#Use the function Partition to create a partition of data
#Partition data from HPLC and sensory merged
part_HPLC_sens <- partition(AllData_HPLC_sens, AllData_HPLC_sens$sensory, 0.7, 1)
```

## Knn classification
Perform classification for knn on HPLC data merged with sens.

```{r}
#Optimisation of k without scaling
optimal1 <- knn.optimisation(part_HPLC_sens$trainSet, part_HPLC_sens$testSet, part_HPLC_sens$trainCl, part_HPLC_sens$testCl, 20, c())

optimal1

#Plot accuracy against time for non scaled data
plot(x = c(1:20), y = optimal1$k.accuracies, type='l', 
           main = "Accuracy by k without scale")

#Optimisation of scale methods and k values
optimal2 <- knn.optimisation(part_HPLC_sens$trainSet, part_HPLC_sens$testSet, part_HPLC_sens$trainCl, part_HPLC_sens$testCl, 20, c("center", "scale", "range"))

optimal2
```
Display the cross table for tunned model (k=7)
```{r}
cross_table_knn(part_HPLC_sens$trainSet, part_HPLC_sens$testSet, part_HPLC_sens$trainCl, part_HPLC_sens$testCl, k = 7)
```


Partition HPLC for 100 iterations, for tunned model (k=7).
```{r}
HPLC_sens_run <- model.run(AllData_HPLC_sens, AllData_HPLC_sens$sensory, 0.7, 100,
          operation = function(trainSet, trainCl, testSet, testCl) {
            trainSet.knn <- trainSet[,1:(ncol(trainSet)-1)]
            testSet.knn <- testSet[,1:(ncol(testSet)-1)]
            #Apply knn model with k=7
            m <- knn(trainSet.knn, testSet.knn, trainCl, 7)
            return(m)
        })

#Calculate cumulative mean
cum_mean_HPLC_knn <- cumulative.mean.accuracy(HPLC_sens_run$accuracies)
```

###knn with enose
Partition and optimise enose data
Partition the data once for enose.
```{r}
#Use the function Partition to create a partition of data

## Data from enose and sensory merged
# Partition data
part_enose_sens <- partition(AllData_enose_sens, AllData_enose_sens$sensory, 0.7, 1)
```

### Knn with enose
Perform classification for knn on HPLC data merged with sens.
```{r}
# Partition data
part_enose_sens <- partition(AllData_enose_sens, AllData_enose_sens$sensory, 0.7, 1)
```


```{r}
#Optimisation of k without scaling
optimal1 <- knn.optimisation(part_enose_sens$trainSet, part_enose_sens$testSet, part_enose_sens$trainCl, part_enose_sens$testCl, 20, c())

optimal1

#Plot accuracy against time for non scaled data
plot(x = c(1:20), y = optimal1$k.accuracies, type='l', 
           main = "Accuracy by k without scale")

#Optimisation of scale methods and k values
optimal2 <- knn.optimisation(part_enose_sens$trainSet, part_enose_sens$testSet, part_enose_sens$trainCl, part_enose_sens$testCl, 20, c("center", "scale", "range"))

optimal2
```

## Classification method 2: RF
### RF with data HPLC

### RF with enose

## Classification method 3:svm - rd
### svm-rd with HCLP

### svm-rd with enose

## 1. 